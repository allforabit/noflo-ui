<link rel="import" href="noflo-account.html">
<link rel="import" href="noflo-new-graph.html">
<link rel="import" href="noflo-new-project.html">
<polymer-element name="noflo-main" attributes="open projects sketches examples">
  <template>
    <noflo-account clientid="9d963a3d-8b6f-42fe-bb36-6fccecd039af"></noflo-account>
    <section id="projects">
      <h2>Projects <small>{{ projects.length }} projects</small></h2>
      <ul>
        <li class="add">
          <h2>New project</h2>
          <button on-click="{{ newProject }}">Create</button>
        </li>
        <template repeat="{{ project in projects }}">
          <li on-click="{{ openProject }}" data-id="{{ project.id }}">
            <the-graph-thumb graphjson="{{ project.mainGraph }}" width="200" height="120"></the-graph-thumb>
            <h2>{{ project.name }}</h2>
            <p>{{ project.graphs.length }}&nbsp;graphs, {{ project.components.length }}&nbsp;components</p>
          </li>
        </template>
      </ul>
    </section>
    <section id="sketches">
      <h2>Sketches <small>{{ sketches.length }} projects</small></h2>
      <ul>
        <li class="add">
          <h2>New sketch</h2>
          <button on-click="{{ newSketch }}">Create</button>
        </li>
        <template repeat="{{ sketch in sketches }}">
          <li on-click="{{ openSketch }}" data-id="{{ sketch.id }}">
            <the-graph-thumb graphjson="{{ sketch }}" width="200" height="120"></the-graph-thumb>
            <h2>{{ sketch.properties.name }}</h2>
          </li>
        </template>
      </ul>
    </section>
    <section id="examples">
      <h2>Examples <small>{{ examples.length }} projects</small></h2>
      <ul>
        <template repeat="{{ examples }}">
        <li on-click="{{ openExample }}" data-id="{{ id }}">
          <h2>{{ name }}</h2>
        </li>
        </template>
      </ul>
    </section>
  </template>
  <script>
    Polymer('noflo-main', {
      open: false,
      projects: [],
      examples: [],
      sketches: [],
      enteredView: function () {
        this.openChanged();
      },
      openChanged: function () {
        if (String(this.open) === 'true') {
          this.style.display = 'block';
          this.style.opacity = 1;
          return;
        }
        this.style.opacity = 0;
        // TODO: On transition end
        setTimeout(function () {
          this.style.display = 'none';
        }.bind(this), 300);
      },
      openSketch: function (event, details, sender) {
        event.preventDefault();
        window.location.hash = '#graph/' + sender.getAttribute('data-id');
      },
      openProject: function (event, details, sender) {
        event.preventDefault();
        var project = null;
        this.projects.forEach(function (p) {
          if (p.id === sender.getAttribute('data-id')) {
            project = p;
          }
        });
        if (!project) {
          return;
        }
        window.location.hash = '#project/' + project.id + '/' + project.main;
      },
      openExample: function (event, details, sender) {
        event.preventDefault();
        window.location.hash = '#example/' + sender.getAttribute('data-id');
      },
      newSketch: function (event) {
        event.preventDefault();
        var dialog = document.createElement('noflo-new-graph');
        this.parentNode.parentNode.appendChild(dialog);
        dialog.addEventListener('new', function (event) {
          this.fire('newsketch', event.detail);
        }.bind(this));
      },
      newProject: function (event) {
        event.preventDefault();
        var dialog = document.createElement('noflo-new-project');
        this.parentNode.parentNode.appendChild(dialog);
        dialog.addEventListener('new', function (event) {
          this.fire('newproject', event.detail);
        }.bind(this));
      }
    });
  </script>
</polymer-element>
